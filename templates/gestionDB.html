<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>dataMAP - gestion de DB</title>
        <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='LOGOTYPE_MAP.ico') }}">
        <style>
            h1 { color: green; }
            .error { color: red; }
        </style>
        <script src="{{ url_for('static', filename='gestionDB.js') }}"></script>

        <script>
            // Example data structure: replace with backend data as needed
            const filterData = {{ filter_data|tojson|safe }}; // {col1: [label1, label2], col2: [label3, ...], ...}
            const currentFilter = {{ current_filter|tojson|safe }}; // Current filter applied
            const attachedLabels = {{ attached_labels|tojson|safe }}; // List of labels attached to the row
            const columns = {{ columnsHTML|tojson|safe }};
        </script>
    </head>

    <body>
        <h1>Gestion de la base de données</h1>
        
        <button id="saveDBBtn" title="Enregistrer la base de donnée (Ctrl+S)" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; font-size: 16px;">
            <svg width="20" height="20" viewBox="0 0 20 20" aria-hidden="true" focusable="false" style="vertical-align: middle;">
                <rect x="2" y="2" width="16" height="16" rx="2" fill="#555"/>
                <rect x="5" y="5" width="10" height="6" fill="#fff"/>
                <rect x="7" y="13" width="6" height="3" fill="#fff"/>
                <rect x="8" y="14" width="4" height="1.5" fill="#bbb"/>
                <rect x="6.5" y="7" width="7" height="2" fill="#bbb"/>
            </svg>
            Enregistrer la base de donnée
        </button>
        
        <br>

        <button onclick="openAffichageModal()">Affichage</button>

        <div id="affichageModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; overflow:auto;">
            <div style="background:white; padding:20px; border-radius:8px; min-width:400px; max-height:90vh; overflow:auto;">
                <h2>Colonnes en détail</h2>
                <div style="display:flex; gap:40px;">
                    <div>
                        <h3>En détail</h3>
                        <ul id="detailCols" style="min-width:150px; min-height:200px; border:1px solid #ccc; padding:10px;" ondrop="drop(event, 'detailCols')" ondragover="allowDrop(event)">
                        </ul>
                    </div>
                    <div>
                        <h3>Non détaillées</h3>
                        <ul id="otherCols" style="min-width:150px; min-height:200px; border:1px solid #ccc; padding:10px;" ondrop="drop(event, 'otherCols')" ondragover="allowDrop(event)">
                        </ul>
                    </div>
                </div>
                <div style="margin-top:20px; text-align:right;">
                    <button onclick="submitAffichage()">Valider</button>
                    <button onclick="closeAffichageModal()">Fermer</button>
                </div>
            </div>
        </div>

        <!-- Filter Modal -->
        <div id="filterModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; overflow:auto;">
            <div style="background:white; padding:20px; border-radius:8px; min-width:400px; max-width:600px; max-height:90vh; overflow:auto; display:flex; flex-direction:column;">
                
                
                <form id="filterForm" style="display:flex; flex-direction:column;">
                    <h2>Filtrer sur les étiquettes</h2>
                    <div id="filterLabels" style="display:flex; gap:40px; flex-wrap:wrap; max-width:100%;">
                        <!-- Columns and filters are injected here by JS -->
                    </div>
                    <h2>Filtrer sur les colonnes</h2>
                    <div id="filterColumns" style="display:flex; gap:40px; flex-wrap:wrap; max-width:100%;">
                        <!-- Columns and filters are injected here by JS -->
                    </div>
                    <div style="margin-top:20px; text-align:right;">
                        <button type="button" onclick="applyFilters()">Appliquer</button>
                        <button type="button" onclick="closeFilterModal()">Fermer</button>
                    </div>
                </form>
            </div>
        </div>
        <button onclick="openFilterModal()">Filtrer</button>

        <!-- Export Modal -->
        <div id="exportModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; overflow:auto;">
            <div style="background:white; padding:20px; border-radius:8px; min-width:400px; max-width:600px; max-height:90vh; overflow:auto;">
                <h2>Exporter les données</h2>
                <form id="exportForm" style="display:flex; flex-direction:column; gap:16px;">
                    <div>
                        <label><strong>Colonnes à exporter :</strong></label>
                        <div id="exportColumns" style="display:flex; flex-wrap:wrap; gap:12px; margin-top:8px;">
                            <!-- Columns checkboxes injected by JS -->
                        </div>
                    </div>
                    <div>
                        <label><strong>Format :</strong></label>
                        <div style="margin-top:8px;">
                            <label><input type="radio" name="exportFormat" value="csv" checked> CSV</label>
                            <label style="margin-left:16px;"><input type="radio" name="exportFormat" value="xlsx"> XLSX</label>
                            <label style="margin-left:16px;"><input type="radio" name="exportFormat" value="raw"> Copier texte brut</label>
                        </div>
                    </div>
                    <div id="rawExportArea" style="display:none; margin-top:8px;">
                        <textarea id="rawExportText" style="width:100%; height:120px;" readonly></textarea>
                        <button type="button" onclick="copyRawExport()">Copier</button>
                    </div>
                    <div style="text-align:right; margin-top:16px;">
                        <button type="button" onclick="submitExport()">Exporter</button>
                        <button type="button" onclick="closeExportModal()">Fermer</button>
                    </div>
                </form>
            </div>
        </div>
        <button onclick="openExportModal()">Exporter</button>


        <div style="display: flex; align-items: flex-start; margin-top: 20px; margin-bottom: 20px;">
            <div style="flex: 1;">
                {{ df|safe }}
            </div>
            <form id="addColumnForm" method="POST" action="/addColumn" style="margin-left: 32px; display: flex; flex-direction: column; background: grey; padding: 16px; border-radius: 8px; min-width: 220px;">
                <input type="text" name="column_name_1" placeholder="Titre 1" list = "titres1" style="margin-bottom: 8px;">
                <datalist id="titres1">
                    <!-- JS injects options here -->
                </datalist>
                <input type="text" name="column_name_2" placeholder="Titre 2" list = "titres2" style="margin-bottom: 8px;">
                <datalist id="titres2">
                    <!-- JS injects options here -->
                </datalist>
                <input type="text" name="column_name_3" placeholder="Titre 3" list = "titres3" required style="margin-bottom: 8px;">
                <datalist id="titres3">
                    <!-- JS injects options here -->
                </datalist>

                <button class="btn btn-success" type="submit">
                    Ajouter une colonne
                </button>
            </form>
        </div>
        


        <div style="width: 100%; margin-bottom: 24px; overflow-x: auto; min-width: 400px;">
            <form id="addRowForm" style="width: max-content; min-width: 100%;">
                <table style="width: max-content; min-width: 100%;">
                    <tr id="addRowInputs">
                        <td id="addRowInputsContainer">
                            <!-- JS injects input fields here -->
                        </td>
                        <td>
                            <button type="button" onclick="submitAddRow()">Ajouter</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        


        <div style="display: flex; justify-content: center; align-items: center; min-height: 60vh;"></div>
            <div id="labelsModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; overflow:auto;">
            <div style="background:white; padding:20px; border-radius:8px; min-width:400px; max-height:90vh; overflow:auto;">
                <h2>Gestion des étiquettes</h2>
                <form id="labelsForm">
                    <input type="hidden" name="rowID" value="{{ rowID }}">
                    {% for label in attached_labels %}
                        <div style="margin-bottom: 8px;">
                            <input type="checkbox" id="label_{{ loop.index }}" name="labels" value="{{ label }}" class="label-checkbox">
                            <label for="label_{{ loop.index }}">{{ label }}</label>
                        </div>
                    {% endfor %}

                    <button type="button" onclick="closeLabelsModal()">Fermer</button>
                    <button type="submit" class="btn" onclick="saveLabelAttribution()">Valider</button>
                </form>
            </div>
            </div>
        </div>
        
        
    </body>
</html>